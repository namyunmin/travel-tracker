name: Test Deployment

on:
  workflow_dispatch:
  push:
    branches: [ test, develop ]

jobs:
  test-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Test SSH Connection
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        script: |
          echo "ğŸ” ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘: $(date)"
          echo "ğŸ“ í˜„ì¬ ìœ„ì¹˜: $(pwd)"
          echo "ğŸ‘¤ ì‚¬ìš©ì: $(whoami)"
          echo "ğŸ§ OS: $(lsb_release -d 2>/dev/null | cut -f2- || cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo "ğŸ Python: $(python3 --version 2>/dev/null || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')"
          echo "ğŸ“¦ Git: $(git --version 2>/dev/null || echo 'ì„¤ì¹˜ë˜ì§€ ì•ŠìŒ')"
          echo "ğŸ’¾ ë©”ëª¨ë¦¬: $(free -h | awk '/^Mem:/ {print $3"/"$2}')"
          echo "ğŸ’¿ ë””ìŠ¤í¬: $(df -h . | awk 'NR==2 {print $3"/"$2" ("$5" ì‚¬ìš©)"}')"
          echo "ğŸŒ ë„¤íŠ¸ì›Œí¬: $(ping -c 1 google.com &> /dev/null && echo 'ì—°ê²°ë¨' || echo 'ì—°ê²° ì‹¤íŒ¨')"
          echo "âœ… ì—°ê²° í…ŒìŠ¤íŠ¸ ì™„ë£Œ: $(date)"
          
    - name: Quick Deploy Test
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 180s
        script: |
          echo "ğŸš€ ê°„ë‹¨í•œ ë°°í¬ í…ŒìŠ¤íŠ¸ ì‹œì‘"
          
          # í…ŒìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
          TEST_DIR="$HOME/travel-tracker-test"
          rm -rf "$TEST_DIR"
          mkdir -p "$TEST_DIR"
          cd "$TEST_DIR"
          
          # ì½”ë“œ í´ë¡ 
          git clone https://github.com/${{ github.repository }}.git .
          
          # Python í™˜ê²½ ì„¤ì •
          python3 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # ê¸°ë³¸ í…ŒìŠ¤íŠ¸
          python3 -c "
          import sys
          sys.path.insert(0, '.')
          from backend.app import app
          print('âœ… Flask ì•± ë¡œë“œ ì„±ê³µ')
          "
          
          # ì •ë¦¬
          cd "$HOME"
          rm -rf "$TEST_DIR"
          
          echo "âœ… ë°°í¬ í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
