name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
          echo "🚀 배포 시작: $(date)"
          
          # 시스템 업데이트 및 필요한 패키지 설치
          sudo apt-get update -y
          sudo apt-get install -y python3-pip python3-venv git
          
          # 프로젝트 디렉토리 설정
          PROJECT_DIR="$HOME/travel-tracker"
          BACKUP_DIR="$HOME/travel-tracker-backup-$(date +%Y%m%d-%H%M%S)"
          
          # 기존 서버 안전하게 중지
          echo "🔄 기존 서버 중지 중..."
          sudo pkill -f "gunicorn.*travel-tracker" || true
          sudo pkill -f "python.*main.py" || true
          sleep 3
          
          # 기존 프로젝트 백업
          if [ -d "$PROJECT_DIR" ]; then
            echo "📦 기존 프로젝트 백업 중..."
            mv "$PROJECT_DIR" "$BACKUP_DIR"
          fi
          
          # 새 코드 클론
          echo "📥 새 코드 다운로드 중..."
          git clone https://github.com/${{ github.repository }}.git "$PROJECT_DIR"
          cd "$PROJECT_DIR"
          
          # Python 가상환경 설정
          echo "🐍 Python 환경 설정 중..."
          python3 -m venv venv
          source venv/bin/activate
          
          # 패키지 설치
          echo "📦 패키지 설치 중..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # 스크립트 실행 권한 설정
          echo "🔧 스크립트 권한 설정 중..."
          chmod +x *.sh
          
          # 데이터베이스 백업 (있을 경우)
          if [ -f "$BACKUP_DIR/location_data.db" ]; then
            echo "💾 데이터베이스 복원 중..."
            cp "$BACKUP_DIR/location_data.db" "$PROJECT_DIR/"
          fi
          
          # 로그 디렉토리 생성
          mkdir -p logs
          
          # 프로덕션 서버 시작
          echo "🚀 프로덕션 서버 시작 중..."
          source venv/bin/activate
          
          # Gunicorn으로 백그라운드 실행
          nohup gunicorn \
            --bind 0.0.0.0:5000 \
            --workers 2 \
            --timeout 120 \
            --keep-alive 60 \
            --max-requests 1000 \
            --max-requests-jitter 100 \
            --access-logfile logs/access.log \
            --error-logfile logs/error.log \
            --log-level info \
            --daemon \
            --pid gunicorn.pid \
            backend.app:app
          
          # 서버 상태 확인
          sleep 5
          if pgrep -f "gunicorn.*travel-tracker" > /dev/null; then
            echo "✅ 서버 시작 성공!"
            echo "🌐 접속 주소: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo 'YOUR-EC2-IP'):5000"
          else
            echo "❌ 서버 시작 실패!"
            echo "📄 에러 로그:"
            tail -20 logs/error.log || echo "로그 파일이 없습니다."
            exit 1
          fi
          
          # 정리 (7일 이상 된 백업 삭제)
          find "$HOME" -name "travel-tracker-backup-*" -type d -mtime +7 -exec rm -rf {} + || true
          
          echo "🎉 배포 완료: $(date)"
