name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 300s
        script: |
          echo "ğŸš€ ë°°í¬ ì‹œì‘: $(date)"
          
          # ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          sudo apt-get update -y
          sudo apt-get install -y python3-pip python3-venv git
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì •
          PROJECT_DIR="$HOME/travel-tracker"
          BACKUP_DIR="$HOME/travel-tracker-backup-$(date +%Y%m%d-%H%M%S)"
          
          # ê¸°ì¡´ ì„œë²„ ì•ˆì „í•˜ê²Œ ì¤‘ì§€
          echo "ğŸ”„ ê¸°ì¡´ ì„œë²„ ì¤‘ì§€ ì¤‘..."
          sudo pkill -f "gunicorn.*travel-tracker" || true
          sudo pkill -f "python.*main.py" || true
          sleep 3
          
          # ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—…
          if [ -d "$PROJECT_DIR" ]; then
            echo "ğŸ“¦ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë°±ì—… ì¤‘..."
            mv "$PROJECT_DIR" "$BACKUP_DIR"
          fi
          
          # ìƒˆ ì½”ë“œ í´ë¡ 
          echo "ğŸ“¥ ìƒˆ ì½”ë“œ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          git clone https://github.com/${{ github.repository }}.git "$PROJECT_DIR"
          cd "$PROJECT_DIR"
          
          # Python ê°€ìƒí™˜ê²½ ì„¤ì •
          echo "ğŸ Python í™˜ê²½ ì„¤ì • ì¤‘..."
          python3 -m venv venv
          source venv/bin/activate
          
          # íŒ¨í‚¤ì§€ ì„¤ì¹˜
          echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
          pip install --upgrade pip
          pip install -r requirements.txt
          
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
          echo "ğŸ”§ ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì • ì¤‘..."
          chmod +x *.sh
          
          # ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… (ìˆì„ ê²½ìš°)
          if [ -f "$BACKUP_DIR/location_data.db" ]; then
            echo "ğŸ’¾ ë°ì´í„°ë² ì´ìŠ¤ ë³µì› ì¤‘..."
            cp "$BACKUP_DIR/location_data.db" "$PROJECT_DIR/"
          fi
          
          # ë¡œê·¸ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p logs
          
          # í”„ë¡œë•ì…˜ ì„œë²„ ì‹œì‘
          echo "ğŸš€ í”„ë¡œë•ì…˜ ì„œë²„ ì‹œì‘ ì¤‘..."
          source venv/bin/activate
          
          # Gunicornìœ¼ë¡œ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
          nohup gunicorn \
            --bind 0.0.0.0:5000 \
            --workers 2 \
            --timeout 120 \
            --keep-alive 60 \
            --max-requests 1000 \
            --max-requests-jitter 100 \
            --access-logfile logs/access.log \
            --error-logfile logs/error.log \
            --log-level info \
            --daemon \
            --pid gunicorn.pid \
            backend.app:app
          
          # ì„œë²„ ìƒíƒœ í™•ì¸
          sleep 5
          if pgrep -f "gunicorn.*travel-tracker" > /dev/null; then
            echo "âœ… ì„œë²„ ì‹œì‘ ì„±ê³µ!"
            echo "ğŸŒ ì ‘ì† ì£¼ì†Œ: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || echo 'YOUR-EC2-IP'):5000"
          else
            echo "âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨!"
            echo "ğŸ“„ ì—ëŸ¬ ë¡œê·¸:"
            tail -20 logs/error.log || echo "ë¡œê·¸ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          # ì •ë¦¬ (7ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ)
          find "$HOME" -name "travel-tracker-backup-*" -type d -mtime +7 -exec rm -rf {} + || true
          
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ: $(date)"
